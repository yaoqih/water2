{
  "id": null,
  "uid": "iot-v1-admin-export",
  "title": "IoT V1 Admin Â· Export",
  "tags": [
    "iot",
    "admin",
    "export"
  ],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 119,
  "refresh": "30s",
  "editable": true,
  "time": {
    "from": "now-24h",
    "to": "now"
  },
  "templating": {
    "list": [
      {
        "name": "export_fields",
        "type": "query",
        "label": "å¯¼å‡ºå­—æ®µ",
        "datasource": "TimescaleDB-RO",
        "query": "SELECT field_key AS __value, (field_label || ' [' || field_key || ']') AS __text FROM admin_api.v_metric_export_fields ORDER BY field_order;",
        "definition": "SELECT field_key AS __value, (field_label || ' [' || field_key || ']') AS __text FROM admin_api.v_metric_export_fields ORDER BY field_order;",
        "refresh": 1,
        "hide": 2,
        "includeAll": false,
        "multi": true,
        "sort": 1,
        "skipUrlSync": false,
        "current": {
          "selected": true,
          "text": [
            "ingest_ts",
            "plant_id",
            "plant_name",
            "point_id",
            "point_type",
            "device_id",
            "metric",
            "value_num",
            "unit"
          ],
          "value": [
            "ingest_ts",
            "plant_id",
            "plant_name",
            "point_id",
            "point_type",
            "device_id",
            "metric",
            "value_num",
            "unit"
          ]
        },
        "options": [],
        "regex": ""
      },
      {
        "name": "export_limit",
        "type": "custom",
        "label": "APIå¯¼å‡ºè¡Œæ•°ä¸Šé™",
        "query": "200,1000,5000,10000,0",
        "current": {
          "selected": true,
          "text": "1000",
          "value": "1000"
        },
        "options": [
          {
            "selected": false,
            "text": "200",
            "value": "200"
          },
          {
            "selected": true,
            "text": "1000",
            "value": "1000"
          },
          {
            "selected": false,
            "text": "5000",
            "value": "5000"
          },
          {
            "selected": false,
            "text": "10000",
            "value": "10000"
          },
          {
            "selected": false,
            "text": "ä¸é™",
            "value": "0"
          }
        ],
        "hide": 2,
        "includeAll": false,
        "multi": false,
        "skipUrlSync": false
      },
      {
        "name": "plant_id",
        "type": "query",
        "label": "plant_id",
        "datasource": "TimescaleDB-RO",
        "query": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT p.plant_id AS __value, p.plant_id AS __text FROM plant p ORDER BY __text;",
        "definition": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT p.plant_id AS __value, p.plant_id AS __text FROM plant p ORDER BY __text;",
        "refresh": 1,
        "hide": 2,
        "includeAll": false,
        "multi": true,
        "sort": 1,
        "skipUrlSync": false,
        "current": {
          "selected": true,
          "text": [
            "å…¨éƒ¨"
          ],
          "value": [
            ""
          ]
        },
        "options": [],
        "regex": ""
      },
      {
        "name": "point_id",
        "type": "query",
        "label": "point_id",
        "datasource": "TimescaleDB-RO",
        "query": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT pt.point_id AS __value, pt.point_id AS __text FROM point pt ORDER BY __text;",
        "definition": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT pt.point_id AS __value, pt.point_id AS __text FROM point pt ORDER BY __text;",
        "refresh": 1,
        "hide": 2,
        "includeAll": false,
        "multi": true,
        "sort": 1,
        "skipUrlSync": false,
        "current": {
          "selected": true,
          "text": [
            "å…¨éƒ¨"
          ],
          "value": [
            ""
          ]
        },
        "options": [],
        "regex": ""
      },
      {
        "name": "device_id",
        "type": "query",
        "label": "device_id",
        "datasource": "TimescaleDB-RO",
        "query": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT d.device_id AS __value, d.device_id AS __text FROM device d ORDER BY __text;",
        "definition": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT d.device_id AS __value, d.device_id AS __text FROM device d ORDER BY __text;",
        "refresh": 1,
        "hide": 2,
        "includeAll": false,
        "multi": true,
        "sort": 1,
        "skipUrlSync": false,
        "current": {
          "selected": true,
          "text": [
            "å…¨éƒ¨"
          ],
          "value": [
            ""
          ]
        },
        "options": [],
        "regex": ""
      },
      {
        "name": "metric",
        "type": "query",
        "label": "metric",
        "datasource": "TimescaleDB-RO",
        "query": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT md.metric AS __value, md.metric AS __text FROM metric_dict md ORDER BY __text;",
        "definition": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT md.metric AS __value, md.metric AS __text FROM metric_dict md ORDER BY __text;",
        "refresh": 1,
        "hide": 2,
        "includeAll": false,
        "multi": true,
        "sort": 1,
        "skipUrlSync": false,
        "current": {
          "selected": true,
          "text": [
            "å…¨éƒ¨"
          ],
          "value": [
            ""
          ]
        },
        "options": [],
        "regex": ""
      },
      {
        "name": "point_type",
        "type": "custom",
        "label": "point_type",
        "query": "all,inlet,outlet",
        "current": {
          "selected": true,
          "text": [
            "all"
          ],
          "value": [
            "all"
          ]
        },
        "options": [
          {
            "selected": true,
            "text": "all",
            "value": "all"
          },
          {
            "selected": false,
            "text": "inlet",
            "value": "inlet"
          },
          {
            "selected": false,
            "text": "outlet",
            "value": "outlet"
          }
        ],
        "hide": 2,
        "includeAll": false,
        "multi": true,
        "skipUrlSync": false
      },
      {
        "name": "topic",
        "type": "query",
        "label": "topic",
        "datasource": "TimescaleDB-RO",
        "query": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT DISTINCT ve.topic AS __value, ve.topic AS __text FROM admin_api.v_metric_export ve WHERE ve.topic IS NOT NULL AND ve.topic <> '' ORDER BY __text;",
        "definition": "SELECT '' AS __value, 'å…¨éƒ¨' AS __text UNION ALL SELECT DISTINCT ve.topic AS __value, ve.topic AS __text FROM admin_api.v_metric_export ve WHERE ve.topic IS NOT NULL AND ve.topic <> '' ORDER BY __text;",
        "refresh": 1,
        "hide": 2,
        "includeAll": false,
        "multi": true,
        "sort": 1,
        "skipUrlSync": false,
        "current": {
          "selected": true,
          "text": [
            "å…¨éƒ¨"
          ],
          "value": [
            ""
          ]
        },
        "options": [],
        "regex": ""
      }
    ]
  },
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "title": "å¯¼èˆª",
      "type": "text",
      "gridPos": {
        "h": 2,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "libraryPanel": {
        "name": "IoT Admin Navigation",
        "uid": "lib_iot_admin_nav"
      },
      "options": {
        "mode": "markdown",
        "content": "[ğŸ  æ€»è§ˆ](/d/iot-v1-admin-home) Â· [ğŸ­ å‚ç«™](/d/iot-v1-admin-plant) Â· [ğŸ“ ç‚¹ä½](/d/iot-v1-admin-point) Â· [ğŸ“Ÿ è®¾å¤‡](/d/iot-v1-admin-device) Â· [ğŸ“š æŒ‡æ ‡](/d/iot-v1-admin-metric) Â· [ğŸ§¾ å¯¼å‡º](/d/iot-v1-admin-export) Â· [ğŸ“ˆ ç›‘æµ‹å¤§å±](/d/iot-v1-plant-monitor)"
      }
    },
    {
      "id": 2,
      "title": "API å¯¼å‡ºè¯´æ˜",
      "type": "text",
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 2
      },
      "options": {
        "mode": "markdown",
        "content": "1. å¯¼èˆªä¸‹æ–¹å…ˆçœ‹è¯´æ˜ï¼Œå†åœ¨ **ç­›é€‰ä¸ä¸‹è½½CSV** ä¸­è®¾ç½®ç­›é€‰ä¸å¯¼å‡ºå­—æ®µã€‚\n2. ç‚¹å‡» **æŸ¥è¯¢**ï¼šæŒ‰å½“å‰ç­›é€‰åˆ·æ–°ä¸‹æ–¹é¢„è§ˆï¼ˆå›ºå®š 500 è¡Œï¼‰ã€‚\n3. ç‚¹å‡» **ä¸‹è½½CSV**ï¼šæŒ‰å½“å‰ç­›é€‰å’Œå¯¼å‡ºå­—æ®µå¯¼å‡ºï¼›API å¯¼å‡ºè¡Œæ•°é€‰æ‹© `ä¸é™` æ—¶ç”±åç«¯æŒ‰å®‰å…¨ç­–ç•¥é™æµã€‚\n4. æ—¶é—´èŒƒå›´åªä½¿ç”¨å³ä¸Šè§’æ—¶é—´é€‰æ‹©å™¨ï¼ˆ`ingest_ts`ï¼‰ã€‚"
      }
    },
    {
      "id": 5,
      "title": "ç­›é€‰ä¸ä¸‹è½½CSV",
      "type": "volkovlabs-form-panel",
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 7
      },
      "datasource": "TimescaleDB-RO",
      "targets": [
        {
          "refId": "B",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT '' AS value, 'å…¨éƒ¨' AS label UNION ALL SELECT p.plant_id AS value, p.plant_id AS label FROM plant p ORDER BY label;"
        },
        {
          "refId": "C",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT '' AS value, 'å…¨éƒ¨' AS label UNION ALL SELECT pt.point_id AS value, pt.point_id AS label FROM point pt ORDER BY label;"
        },
        {
          "refId": "D",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT '' AS value, 'å…¨éƒ¨' AS label UNION ALL SELECT d.device_id AS value, d.device_id AS label FROM device d ORDER BY label;"
        },
        {
          "refId": "E",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT '' AS value, 'å…¨éƒ¨' AS label UNION ALL SELECT md.metric AS value, md.metric AS label FROM metric_dict md ORDER BY label;"
        },
        {
          "refId": "F",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT '' AS value, 'å…¨éƒ¨' AS label UNION ALL SELECT DISTINCT ve.topic AS value, ve.topic AS label FROM admin_api.v_metric_export ve WHERE ve.topic IS NOT NULL AND ve.topic <> '' ORDER BY label;"
        }
      ],
      "pluginVersion": "6.3.1",
      "options": {
        "buttonGroup": {
          "orientation": "center",
          "size": "md"
        },
        "confirmModal": {
          "title": "ç¡®è®¤å¯¼å‡º",
          "body": "ç¡®è®¤ä¸‹è½½å½“å‰ç­›é€‰ç»“æœï¼Ÿ",
          "confirm": "ç¡®è®¤",
          "cancel": "å–æ¶ˆ",
          "elementDisplayMode": "all",
          "columns": {
            "include": [
              "name",
              "newValue"
            ],
            "name": "å­—æ®µ",
            "newValue": "å€¼"
          }
        },
        "elements": [
          {
            "fieldName": "plant_id",
            "id": "plant_id",
            "options": [],
            "optionsSource": "Query",
            "queryOptions": {
              "label": "label",
              "source": "B",
              "value": "value"
            },
            "title": "plant_id",
            "type": "multiselect",
            "value": [
              ""
            ]
          },
          {
            "fieldName": "point_id",
            "id": "point_id",
            "options": [],
            "optionsSource": "Query",
            "queryOptions": {
              "label": "label",
              "source": "C",
              "value": "value"
            },
            "title": "point_id",
            "type": "multiselect",
            "value": [
              ""
            ]
          },
          {
            "fieldName": "device_id",
            "id": "device_id",
            "options": [],
            "optionsSource": "Query",
            "queryOptions": {
              "label": "label",
              "source": "D",
              "value": "value"
            },
            "title": "device_id",
            "type": "multiselect",
            "value": [
              ""
            ]
          },
          {
            "fieldName": "metric",
            "id": "metric",
            "options": [],
            "optionsSource": "Query",
            "queryOptions": {
              "label": "label",
              "source": "E",
              "value": "value"
            },
            "title": "metric",
            "type": "multiselect",
            "value": [
              ""
            ]
          },
          {
            "fieldName": "point_type",
            "id": "point_type",
            "title": "point_type",
            "type": "multiselect",
            "value": [
              "all"
            ],
            "options": [
              {
                "label": "all",
                "value": "all"
              },
              {
                "label": "inlet",
                "value": "inlet"
              },
              {
                "label": "outlet",
                "value": "outlet"
              }
            ]
          },
          {
            "fieldName": "topic",
            "id": "topic",
            "options": [],
            "optionsSource": "Query",
            "queryOptions": {
              "label": "label",
              "source": "F",
              "value": "value"
            },
            "title": "topic",
            "type": "multiselect",
            "value": [
              ""
            ]
          },
          {
            "fieldName": "export_fields",
            "id": "export_fields",
            "title": "å¯¼å‡ºå­—æ®µ",
            "type": "multiselect",
            "value": [
              "ingest_ts",
              "plant_id",
              "plant_name",
              "point_id",
              "point_type",
              "device_id",
              "metric",
              "value_num",
              "unit"
            ],
            "options": [
              {
                "label": "ingest_ts",
                "value": "ingest_ts"
              },
              {
                "label": "plant_id",
                "value": "plant_id"
              },
              {
                "label": "plant_name",
                "value": "plant_name"
              },
              {
                "label": "point_id",
                "value": "point_id"
              },
              {
                "label": "point_name",
                "value": "point_name"
              },
              {
                "label": "point_type",
                "value": "point_type"
              },
              {
                "label": "device_id",
                "value": "device_id"
              },
              {
                "label": "metric",
                "value": "metric"
              },
              {
                "label": "value_num",
                "value": "value_num"
              },
              {
                "label": "unit",
                "value": "unit"
              },
              {
                "label": "alarm_low",
                "value": "alarm_low"
              },
              {
                "label": "alarm_high",
                "value": "alarm_high"
              },
              {
                "label": "topic",
                "value": "topic"
              }
            ]
          },
          {
            "fieldName": "export_limit",
            "id": "export_limit",
            "title": "APIå¯¼å‡ºè¡Œæ•°ä¸Šé™",
            "type": "select",
            "value": "1000",
            "options": [
              {
                "label": "200",
                "value": "200"
              },
              {
                "label": "1000",
                "value": "1000"
              },
              {
                "label": "5000",
                "value": "5000"
              },
              {
                "label": "10000",
                "value": "10000"
              },
              {
                "label": "ä¸é™",
                "value": "0"
              }
            ]
          }
        ],
        "initial": {
          "code": "context.panel.enableSubmit();\nconst defaultFields = ['ingest_ts','plant_id','plant_name','point_id','point_type','device_id','metric','value_num','unit'];\nconst txt = (v) => (v === null || v === undefined ? '' : String(v).trim());\n\nconst parseFields = (raw) => {\n  const s = txt(raw);\n  if (!s || s.includes('${')) return defaultFields;\n  const arr = s.split(',').map((v) => txt(v)).filter(Boolean);\n  return arr.length ? arr : defaultFields;\n};\n\nconst parseMulti = (raw, fallback) => {\n  const s = txt(raw);\n  if (!s || s.includes('${')) return [fallback];\n  const seen = {};\n  const out = [];\n  for (const part of s.split(',')) {\n    const item = txt(part);\n    if (!item && fallback !== '') continue;\n    if (seen[item]) continue;\n    seen[item] = true;\n    out.push(item);\n  }\n  if (!out.length) return [fallback];\n  if (out.includes(fallback)) return [fallback];\n  return out;\n};\n\nconst parsePointType = (raw) => {\n  const allowed = ['all', 'inlet', 'outlet'];\n  const arr = parseMulti(raw, 'all').map((v) => txt(v).toLowerCase());\n  const seen = {};\n  const out = [];\n  for (const v of arr) {\n    if (!allowed.includes(v) || seen[v]) continue;\n    seen[v] = true;\n    out.push(v);\n  }\n  if (!out.length || out.includes('all')) return ['all'];\n  return out;\n};\n\ncontext.panel.setFormValue({\n  plant_id: parseMulti('${plant_id:csv}', ''),\n  point_id: parseMulti('${point_id:csv}', ''),\n  device_id: parseMulti('${device_id:csv}', ''),\n  metric: parseMulti('${metric:csv}', ''),\n  point_type: parsePointType('${point_type:csv}'),\n  topic: parseMulti('${topic:csv}', ''),\n  export_fields: parseFields('${export_fields:csv}'),\n  export_limit: '${export_limit}' || '1000'\n});",
          "contentType": "application/json",
          "getPayload": "return { rawSql: '', format: 'table' };",
          "highlight": false,
          "highlightColor": "red",
          "method": "query",
          "payload": {}
        },
        "layout": {
          "orientation": "horizontal",
          "padding": 10,
          "sectionVariant": "default",
          "variant": "single"
        },
        "reset": {
          "icon": "search",
          "text": "æŸ¥è¯¢",
          "variant": "secondary"
        },
        "resetAction": {
          "code": "const get = (id) => context.panel.elements.find((e) => e.id === id)?.value;\nconst txt = (v) => (v === null || v === undefined ? '' : String(v).trim());\nconst grafana = context?.grafana;\nconst defaultFields = ['ingest_ts','plant_id','plant_name','point_id','point_type','device_id','metric','value_num','unit'];\n\nconst notifyError = (title, msg) => {\n  if (grafana && typeof grafana.notifyError === 'function') {\n    grafana.notifyError([title, msg]);\n    return;\n  }\n  if (typeof console !== 'undefined' && typeof console.error === 'function') {\n    console.error(title + ': ' + msg);\n  }\n};\n\nconst safeApplyVars = (vars) => {\n  if (grafana?.locationService && typeof grafana.locationService.partial === 'function') {\n    grafana.locationService.partial(vars, true);\n    return true;\n  }\n  notifyError('æŸ¥è¯¢å¤±è´¥', 'å½“å‰ç¯å¢ƒç¼ºå°‘ locationServiceï¼Œæ— æ³•åˆ·æ–°ç­›é€‰å˜é‡');\n  return false;\n};\n\nconst safeRefresh = () => {\n  if (grafana && typeof grafana.refresh === 'function') {\n    grafana.refresh();\n  }\n};\n\nconst normalizeFields = (raw) => {\n  const arr = Array.isArray(raw) ? raw : [];\n  const out = [];\n  const seen = {};\n  for (const item of arr) {\n    const value = txt(item);\n    if (!value || seen[value]) continue;\n    seen[value] = true;\n    out.push(value);\n  }\n  return out.length ? out : defaultFields;\n};\n\nconst normalizeFilter = (raw, allToken = '') => {\n  const arr = Array.isArray(raw) ? raw : [raw];\n  const out = [];\n  const seen = {};\n  for (const item of arr) {\n    const value = txt(item);\n    if (!value && allToken !== '') continue;\n    if (seen[value]) continue;\n    seen[value] = true;\n    out.push(value);\n  }\n  if (!out.length) return [allToken];\n  if (!out.includes(allToken)) return out;\n  if (out.length === 1) return [allToken];\n  const last = out[out.length - 1];\n  if (last === allToken) return [allToken];\n  return out.filter((v) => v !== allToken);\n};\n\nconst normalizePointType = (raw) => {\n  const allowed = ['all', 'inlet', 'outlet'];\n  const arr = normalizeFilter(raw, 'all').map((v) => txt(v).toLowerCase());\n  const out = [];\n  const seen = {};\n  for (const item of arr) {\n    if (!allowed.includes(item) || seen[item]) continue;\n    seen[item] = true;\n    out.push(item);\n  }\n  if (!out.length || out.includes('all')) return ['all'];\n  return out;\n};\n\nconst fields = normalizeFields(get('export_fields'));\nconst plantIds = normalizeFilter(get('plant_id'), '');\nconst pointIds = normalizeFilter(get('point_id'), '');\nconst deviceIds = normalizeFilter(get('device_id'), '');\nconst metrics = normalizeFilter(get('metric'), '');\nconst pointTypes = normalizePointType(get('point_type'));\nconst topics = normalizeFilter(get('topic'), '');\n\nif (safeApplyVars({\n  'var-plant_id': plantIds,\n  'var-point_id': pointIds,\n  'var-device_id': deviceIds,\n  'var-metric': metrics,\n  'var-point_type': pointTypes,\n  'var-topic': topics,\n  'var-export_fields': fields,\n  'var-export_limit': txt(get('export_limit')) || '1000'\n})) {\n  safeRefresh();\n}",
          "confirm": false,
          "getPayload": "return {};",
          "mode": "custom",
          "payload": {}
        },
        "saveDefault": {
          "icon": "save",
          "text": "Save Default",
          "variant": "hidden"
        },
        "submit": {
          "icon": "save",
          "text": "ä¸‹è½½CSV",
          "variant": "primary"
        },
        "sync": true,
        "update": {
          "code": "const get = (id) => context.panel.elements.find((e) => e.id === id)?.value;\nconst txt = (v) => (v === null || v === undefined ? '' : String(v).trim());\nconst grafana = context?.grafana;\nconst notifySuccess = (title, msg) => {\n  if (grafana && typeof grafana.notifySuccess === 'function') {\n    grafana.notifySuccess([title, msg]);\n    return;\n  }\n  if (typeof console !== 'undefined' && typeof console.log === 'function') {\n    console.log(title + ': ' + msg);\n  }\n};\nconst notifyError = (title, msg) => {\n  if (grafana && typeof grafana.notifyError === 'function') {\n    grafana.notifyError([title, msg]);\n    return;\n  }\n  if (typeof console !== 'undefined' && typeof console.error === 'function') {\n    console.error(title + ': ' + msg);\n  }\n};\n\nconst allowedFields = [\n  'ingest_ts',\n  'plant_id',\n  'plant_name',\n  'plant_timezone',\n  'point_id',\n  'point_name',\n  'point_type',\n  'device_id',\n  'metric',\n  'unit',\n  'alarm_low',\n  'alarm_high',\n  'value_num',\n  'topic',\n  'raw_id'\n];\nconst defaultFields = [\n  'ingest_ts',\n  'plant_id',\n  'plant_name',\n  'point_id',\n  'point_type',\n  'device_id',\n  'metric',\n  'value_num',\n  'unit'\n];\n\nconst normalizeFields = (raw) => {\n  const arr = Array.isArray(raw) ? raw : [];\n  const seen = {};\n  const out = [];\n  for (const item of arr) {\n    const f = txt(item).toLowerCase();\n    if (!f || !allowedFields.includes(f) || seen[f]) continue;\n    seen[f] = true;\n    out.push(f);\n  }\n  return out.length ? out : defaultFields;\n};\n\nconst toArray = (v) => {\n  if (!v) return [];\n  if (Array.isArray(v)) return v;\n  if (Array.isArray(v.buffer)) return v.buffer;\n  if (Array.isArray(v.values)) return v.values;\n  if (typeof v.toArray === 'function') {\n    try {\n      const arr = v.toArray();\n      return Array.isArray(arr) ? arr : [];\n    } catch (_) {\n      return [];\n    }\n  }\n  return [];\n};\n\nconst normalizeFrame = (frame) => {\n  if (!frame) return null;\n  if (frame?.schema?.fields && Array.isArray(frame?.data?.values)) {\n    const headers = frame.schema.fields.map((f) => f.name);\n    const values = frame.data.values.map((col) => toArray(col));\n    return headers.length ? { headers, values } : null;\n  }\n  if (Array.isArray(frame?.fields)) {\n    const headers = frame.fields.map((f) => f?.name || '');\n    const values = frame.fields.map((f) => toArray(f?.values));\n    return headers.length ? { headers, values } : null;\n  }\n  return null;\n};\n\nconst findTableIn = (obj) => {\n  const candidates = [\n    obj?.results?.A?.frames?.[0],\n    obj?.data?.results?.A?.frames?.[0],\n    obj?.A?.frames?.[0],\n    obj?.response?.results?.A?.frames?.[0],\n    obj?.response?.data?.results?.A?.frames?.[0],\n    obj?.payload?.results?.A?.frames?.[0],\n    obj?.result?.frames?.[0],\n    obj?.frames?.[0],\n    ...(Array.isArray(obj?.data) ? obj.data : []),\n    ...(Array.isArray(obj?.response?.data) ? obj.response.data : [])\n  ];\n  for (const c of candidates) {\n    const normalized = normalizeFrame(c);\n    if (normalized) return normalized;\n  }\n  return null;\n};\n\nconst parseRowObjects = (resp) => {\n  const table = findTableIn(resp || {});\n  if (!table) {\n    return [];\n  }\n  const idx = table.headers.indexOf('row_data');\n  if (idx < 0) {\n    throw new Error('å¯¼å‡ºè¿”å›ç¼ºå°‘ row_data åˆ—');\n  }\n  return toArray(table.values[idx]).map((v) => {\n    if (v === null || v === undefined) return {};\n    if (typeof v === 'string') {\n      try {\n        return JSON.parse(v);\n      } catch (_) {\n        return {};\n      }\n    }\n    if (typeof v === 'object') return v;\n    return {};\n  });\n};\n\nconst escCsv = (v) => {\n  if (v === null || v === undefined) return '';\n  const s = String(v);\n  return /[\",\\n\\r]/.test(s) ? '\"' + s.replace(/\"/g, '\"\"') + '\"' : s;\n};\n\nconst buildCsv = (rows, fields) => {\n  const lines = [fields.map(escCsv).join(',')];\n  for (const row of rows) {\n    const cols = fields.map((f) => escCsv(row?.[f]));\n    lines.push(cols.join(','));\n  }\n  return { csv: '\\ufeff' + lines.join('\\n'), rowCount: rows.length };\n};\n\nconst saveCsvText = (csvText, filename) => {\n  if (typeof document === 'undefined' || typeof URL === 'undefined') {\n    throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒæµè§ˆå™¨ä¸‹è½½');\n  }\n\n  const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });\n  const href = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = href;\n  a.download = filename;\n  a.rel = 'noopener';\n  a.style.display = 'none';\n  (document.body || document.documentElement).appendChild(a);\n  a.click();\n  a.remove();\n  setTimeout(() => URL.revokeObjectURL(href), 1000);\n};\n\nif (!(context.panel.response && context.panel.response.state === 'Done')) {\n  notifyError('å¯¼å‡ºå¤±è´¥', 'å¯¼å‡ºæŸ¥è¯¢æœªå®Œæˆ');\n  return;\n}\n\nreturn (async () => {\n  try {\n    const selectedFields = normalizeFields(get('export_fields'));\n    const rows = parseRowObjects(context.panel.response);\n    const { csv, rowCount } = buildCsv(rows, selectedFields);\n    const ts = new Date().toISOString().replace(/[.:]/g, '-');\n    const filename = `metric_export_${ts}.csv`;\n    saveCsvText(csv, filename);\n    notifySuccess('å¯¼å‡ºæˆåŠŸ', `å·²ä¸‹è½½ ${rowCount} è¡Œ`);\n  } catch (error) {\n    const msg = error?.message || error?.statusText || 'å¯¼å‡ºè¯·æ±‚å¤±è´¥';\n    notifyError('å¯¼å‡ºå¤±è´¥', msg);\n  }\n})();\n",
          "confirm": false,
          "contentType": "application/json",
          "datasource": "TimescaleDB-RO",
          "getPayload": "const get = (id) => context.panel.elements.find((e) => e.id === id)?.value;\nconst txt = (v) => (v === null || v === undefined ? '' : String(v).trim());\nconst escSql = (v) => String(v).replace(/'/g, \"''\");\n\nconst allowedFields = [\n  'ingest_ts',\n  'plant_id',\n  'plant_name',\n  'plant_timezone',\n  'point_id',\n  'point_name',\n  'point_type',\n  'device_id',\n  'metric',\n  'unit',\n  'alarm_low',\n  'alarm_high',\n  'value_num',\n  'topic',\n  'raw_id'\n];\nconst defaultFields = [\n  'ingest_ts',\n  'plant_id',\n  'plant_name',\n  'point_id',\n  'point_type',\n  'device_id',\n  'metric',\n  'value_num',\n  'unit'\n];\n\nconst normalizeFields = (raw) => {\n  const arr = Array.isArray(raw) ? raw : [];\n  const seen = {};\n  const out = [];\n  for (const item of arr) {\n    const f = txt(item).toLowerCase();\n    if (!f || !allowedFields.includes(f) || seen[f]) continue;\n    seen[f] = true;\n    out.push(f);\n  }\n  return out.length ? out : defaultFields;\n};\n\nconst normalizeFilter = (raw, allToken = '') => {\n  const arr = Array.isArray(raw) ? raw : [raw];\n  const seen = {};\n  const out = [];\n  for (const item of arr) {\n    const value = txt(item);\n    if (!value && allToken !== '') continue;\n    if (seen[value]) continue;\n    seen[value] = true;\n    out.push(value);\n  }\n  if (!out.length) return [allToken];\n  if (!out.includes(allToken)) return out;\n  if (out.length === 1) return [allToken];\n  const last = out[out.length - 1];\n  if (last === allToken) return [allToken];\n  return out.filter((v) => v !== allToken);\n};\n\nconst normalizePointType = (raw) => {\n  const allowed = ['all', 'inlet', 'outlet'];\n  const arr = normalizeFilter(raw, 'all').map((v) => txt(v).toLowerCase());\n  const seen = {};\n  const out = [];\n  for (const item of arr) {\n    if (!allowed.includes(item) || seen[item]) continue;\n    seen[item] = true;\n    out.push(item);\n  }\n  if (!out.length || out.includes('all')) return ['all'];\n  return out;\n};\n\nconst toNullableTextSql = (v) => {\n  const s = txt(v);\n  return s ? `'${escSql(s)}'` : 'NULL';\n};\n\nconst toNullableCsvSql = (values, allToken = '') => {\n  const arr = normalizeFilter(values, allToken);\n  if (arr.includes(allToken)) return 'NULL';\n  return toNullableTextSql(arr.join(','));\n};\n\nconst toTextArraySql = (fields) => {\n  if (!fields.length) return 'NULL';\n  return 'ARRAY[' + fields.map((f) => `'${escSql(f)}'`).join(',') + ']';\n};\n\nconst toLimitSql = (v) => {\n  const n = Number(txt(v) || '1000');\n  if (!Number.isFinite(n)) return '1000';\n  const rounded = Math.round(n);\n  if (rounded <= 0) return '0';\n  return String(Math.min(rounded, 50000));\n};\n\nconst toMsRaw = Number('${__to}');\nconst fromMsRaw = Number('${__from}');\nconst now = Date.now();\nconst fromMs = Number.isFinite(fromMsRaw) ? fromMsRaw : (now - 24 * 3600 * 1000);\nconst toMs = Number.isFinite(toMsRaw) ? toMsRaw : now;\nconst fromIso = new Date(fromMs).toISOString();\nconst toIso = new Date(toMs).toISOString();\n\nconst fields = normalizeFields(get('export_fields'));\nconst plantIds = normalizeFilter(get('plant_id'), '');\nconst pointIds = normalizeFilter(get('point_id'), '');\nconst deviceIds = normalizeFilter(get('device_id'), '');\nconst metrics = normalizeFilter(get('metric'), '');\nconst pointTypes = normalizePointType(get('point_type'));\nconst topics = normalizeFilter(get('topic'), '');\n\nreturn {\n  fields_csv: fields.join(','),\n  fields_sql: toTextArraySql(fields),\n  from_sql: `'${fromIso}'`,\n  to_sql: `'${toIso}'`,\n  plant_id_sql: toNullableCsvSql(plantIds, ''),\n  point_id_sql: toNullableCsvSql(pointIds, ''),\n  device_id_sql: toNullableCsvSql(deviceIds, ''),\n  metric_sql: toNullableCsvSql(metrics, ''),\n  point_type_sql: toNullableCsvSql(pointTypes, 'all'),\n  topic_sql: toNullableCsvSql(topics, ''),\n  limit_sql: toLimitSql(get('export_limit')),\n};",
          "method": "datasource",
          "payload": {
            "editorMode": "code",
            "format": "table",
            "rawQuery": true,
            "rawSql": "SELECT row_data\nFROM admin_api.export_metric_rows(\n  ${payload.fields_sql}::text[],\n  ${payload.from_sql}::timestamptz,\n  ${payload.to_sql}::timestamptz,\n  ${payload.plant_id_sql}::text,\n  ${payload.point_id_sql}::text,\n  ${payload.device_id_sql}::text,\n  ${payload.metric_sql}::text,\n  ${payload.point_type_sql}::text,\n  ${payload.topic_sql}::text,\n  ${payload.limit_sql}\n);\n",
            "refId": "A",
            "sql": {
              "columns": [
                {
                  "parameters": [],
                  "type": "function"
                }
              ],
              "groupBy": [
                {
                  "property": {
                    "type": "string"
                  },
                  "type": "groupBy"
                }
              ],
              "limit": 50000
            }
          },
          "payloadMode": "custom"
        },
        "updateEnabled": "manual",
        "elementValueChanged": "const txt = (v) => (v === null || v === undefined ? '' : String(v).trim());\nconst id = context.element?.id;\nif (!id) return;\n\nconst normalize = (raw, allToken = '') => {\n  const arr = Array.isArray(raw) ? raw : [raw];\n  const out = [];\n  const seen = {};\n  for (const item of arr) {\n    const value = txt(item);\n    if (!value && allToken !== '') continue;\n    if (seen[value]) continue;\n    seen[value] = true;\n    out.push(value);\n  }\n  if (!out.length) return [allToken];\n  if (!out.includes(allToken)) return out;\n  if (out.length === 1) return [allToken];\n  const last = out[out.length - 1];\n  if (last === allToken) return [allToken];\n  return out.filter((v) => v !== allToken);\n};\n\nconst asArray = (raw) => (Array.isArray(raw) ? raw.map((v) => txt(v)) : [txt(raw)]);\nconst sameArray = (a, b) => {\n  if (!Array.isArray(a) || !Array.isArray(b) || a.length !== b.length) return false;\n  for (let i = 0; i < a.length; i++) {\n    if (txt(a[i]) !== txt(b[i])) return false;\n  }\n  return true;\n};\n\nlet next = null;\nif (['plant_id', 'point_id', 'device_id', 'metric', 'topic'].includes(id)) {\n  next = normalize(context.element.value, '');\n}\n\nif (id === 'point_type') {\n  const allowed = ['all', 'inlet', 'outlet'];\n  next = normalize(context.element.value, 'all').map((v) => txt(v).toLowerCase()).filter((v) => allowed.includes(v));\n  if (!next.length || next.includes('all')) next = ['all'];\n}\n\nif (!next) return;\nconst current = asArray(context.element.value);\nif (sameArray(current, next)) return;\ncontext.panel.setFormValue({ [id]: next });"
      }
    },
    {
      "id": 4,
      "title": "å¯¼å‡ºé¢„è§ˆï¼ˆå¸¸ç”¨ç­›é€‰ï¼‰",
      "type": "table",
      "gridPos": {
        "h": 14,
        "w": 24,
        "x": 0,
        "y": 21
      },
      "datasource": "TimescaleDB-RO",
      "targets": [
        {
          "refId": "A",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT ingest_ts,\n       plant_id,\n       plant_name,\n       point_id,\n       point_name,\n       point_type,\n       device_id,\n       metric,\n       value_num,\n       unit,\n       alarm_low,\n       alarm_high,\n       topic\nFROM admin_api.v_metric_export\nWHERE ingest_ts >= $__timeFrom()\n  AND ingest_ts < $__timeTo()\n  AND ('' = ANY(ARRAY[${plant_id:sqlstring}]::text[]) OR plant_id = ANY(ARRAY[${plant_id:sqlstring}]::text[]))\n  AND ('' = ANY(ARRAY[${point_id:sqlstring}]::text[]) OR point_id = ANY(ARRAY[${point_id:sqlstring}]::text[]))\n  AND ('' = ANY(ARRAY[${device_id:sqlstring}]::text[]) OR device_id = ANY(ARRAY[${device_id:sqlstring}]::text[]))\n  AND ('' = ANY(ARRAY[${metric:sqlstring}]::text[]) OR metric = ANY(ARRAY[${metric:sqlstring}]::text[]))\n  AND ('all' = ANY(ARRAY[${point_type:sqlstring}]::text[]) OR point_type = ANY(ARRAY[${point_type:sqlstring}]::text[]))\n  AND ('' = ANY(ARRAY[${topic:sqlstring}]::text[]) OR topic = ANY(ARRAY[${topic:sqlstring}]::text[]))\nORDER BY ingest_ts DESC\nLIMIT 500;"
        }
      ]
    }
  ]
}
